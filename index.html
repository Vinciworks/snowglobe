<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Snow Globe</title>
  <script src="TweenMax.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700');

    html {
      font-size: 2vh;
    }

    body {
      height: 100vh;
      max-height: 100vh;
      margin: 0;
      font-family: 'Libre Baskerville', serif;
      overflow: hidden;
      background: #84c0ff;
      background-image: radial-gradient(
        circle at 50% 80%,
        rgba(50, 110, 218, 0.0) 20%,
        rgba(50, 110, 218, 0.7)
      );
      background-size: cover;
      text-align: center;
      color: #fff;
      letter-spacing: 0.05em;
    }

    .logo {
      width: 7em;
      height: 1.5em;
      display: inline-block;
      background: url(img/vinciworks.svg) no-repeat;
      background-size: contain;
      margin: 2rem 0 0.5rem;
    }

    h1, h2, h3, a {
      font-weight: 400;
      text-shadow: 0 2px 10px rgba(50, 110, 218, 0.8);
      font-style: italic;
      letter-spacing: 0.08em;
    }

    h1 {
      margin: 0.5rem;
      font-style: normal;
      font-size: 2.6rem;
      line-height: 1;
      letter-spacing: 0.06em;
      font-weight: 700;
    }

    a:link, a:visited {
      color: #fff;
      font-style: normal;
      text-decoration: none;
      font-size: 0.8em;
      padding: 1ch 0.5ch;
    }

    #mute {
      position: fixed;
      top: 1em;
      left: 1em;
      height: 2em;
      width: 2em;
      background: url(img/unmute.svg) no-repeat;
      background-size: contain;
    }

    .-mute #mute {
      background-image: url(img/mute.svg);
    }


    #snow-globe {      
      font-size: 0.85vh;
      position: relative;
      width: 60em;
      height: 75em;
      margin: 2rem auto;
      /*margin-top: 5%;*/
    }

    #toy {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      width: auto;
      height: auto;
      transform-origin: 150% 90%;
      z-index: 1;
    }

    #globe * {
      pointer-events: none;
    }

    #globe {
      cursor: pointer;
      width: 60em;
      height: 60em;
      position: absolute;
      top: 0;
      left: 0;
      margin: auto;
      border-radius: 50%; 
      background: #173f7d url(img/globe.jpg);
      background-position: 50%;
      background-size: cover;
      overflow: hidden;
      perspective: 10000px;
      perspective-origin: 50% 75%;
    }

    .flakes, #reflection {
      position: absolute;
      top: -2em;
      bottom: -2em;
      left: 0;
      right: 0;
      width: auto;
      height: auto;
    }

    .flake {
      position: absolute;
      transform-style: preserve-3d;
      top: -6em;
      width: 1em;
      height: 1em;
      background: #fff;
      transform-origin: 0% 250%;
      border-radius: 40%;
    }

    #reflection {
      background-image: url(img/reflection.png);
      background-size: cover;
      background-position: 50%;      
    }

    #stand {
      background: url(img/stand.png) no-repeat;
      background-size: contain;
      background-position: 50%;

      position: absolute;
      top: 57em;
      width: 100%;
      height: 20em;
      left: 0;
      pointer-events:none;
    }

    #toy-shadow {
      position: absolute;
      bottom: -19em;
      width: 160%;
      margin-left: -30%;
      height: 20em;
      left: 0;
      background-image: radial-gradient(closest-side, rgba(50, 110, 218, 0.5) 20%, transparent 90%);
      z-index: -1;
    }

    #clickme {
      position: absolute;
      right: -33em;
      top: 45em;
      width: 33em;
      height: 5em;
      background-image: url(img/clickme.png);
      background-size: contain;
      background-position: 50%;
      background-repeat: no-repeat;
      opacity: 0.4;
      transition: 0.7s;
      transform: rotate(12deg) skew(6deg);
    }

    @media (max-aspect-ratio: 1/1) {
      #clickme {      
        position: absolute;
        right: -18em;
        top: 0;
        width: 33em;
        height: 3.9em;
        background-image: url(img/clickme.png);
        background-size: contain;
        background-position: 50%;
        background-repeat: no-repeat;
        opacity: 0.6;
        transition: 0.7s;
        transform: rotate(-12deg) skew(6deg);
      }
    }

    .animal {
      position: absolute;
      bottom: 4em;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 100%;
      height: 33em;
      background-size: contain;
      background-position: 50%;
      background-repeat: no-repeat;
      opacity: 0;
      visibility: hidden;
    }

    .fox     {background-image: url(img/sequence/fox1.png);     height: 25.8em;}
    .deer    {background-image: url(img/sequence/deer1.png);    height: 46em;  }
    .man     {background-image: url(img/man.png);               height: 45.4em;}
    .owl     {background-image: url(img/sequence/owl1.png);     height: 21.8em;}
    .yeti    {background-image: url(img/sequence/yeti1.png);    height: 60em;  }
    .rabbit  {background-image: url(img/sequence/rabbit1.png);  height: 22.7em;}
    .penguin {background-image: url(img/sequence/penguin1.png); height: 25.1em;}

    .man {animation: shiver 0.2s infinite;transform-origin: 50% 97%}

    @keyframes shiver {
      0% {transform: skew(-1deg)}
      50% {transform: skew(0deg)}
      100% {transform: skew(-1deg)}
    }

  #wrapper {
    z-index: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  </style>
</head>
<body>
  <div id="wrapper">
    <div id="mute"></div>
    <div class="logo"></div>
    <h1>Seasons Greetings</h1>
    <!-- <h2>Wishing you a chilled holiday</h2> -->
    <div id="snow-globe">
      <div id="toy-shadow"></div>
      <div id="clickme"></div>
      <div id="toy">
        <div id="globe">
          <div class="flakes"></div>    
          <div data-animal="fox" data-yoyo="1" class="animal fox"></div>
          <div data-animal="deer" class="animal deer"></div>
          <div data-animal="man" class="animal man"></div>
          <div data-animal="rabbit" data-yoyo="1" class="animal rabbit"></div>
          <div data-animal="owl" class="animal owl"></div>
          <div data-animal="yeti" class="animal yeti"></div>
          <div data-animal="penguin" class="animal penguin"></div>
          <div class="flakes"></div>
          <div id="reflection"></div>
        </div>
        <div id="stand"></div>
      </div>

    </div>
    <div>
      <h3>Wishing you a chilled holiday, from the team at VinciWorks</h3>
    </div>
    <div id="footer">
      
        <div class="links-wrapper">
          <a class="web" href="https://vinciworks.com/" target="_blank"> Website </a> &middot;
          <a class="blog" href="http://vinciworks.com/blog/" target="_blank"> Blog </a>  &middot;
          <a class="twitter" href="https://twitter.com/vinciworks" target="_blank"> Twitter </a> 
        </div>
      </div> 

  </div>

  <script>
    !(function initSnowGlobe() {
      var n = 200;
      var fallSpeed = 7;
      var flakes = [];
      var tls = [];
      var flakesContainers = document.getElementsByClassName('flakes');
      var toy = document.getElementById('toy');
      var shadow = document.getElementById('toy-shadow');
      var globe = document.getElementById('globe');
      var h = flakesContainers[0].offsetHeight;
      var animals = document.getElementsByClassName('animal');
      var animalCount = animals.length;
      var animalIndex = 0;

      var i, iMax;
      var j, jMax;
      var sequences = {
        deer: 9,
        fox: 20,
        owl: 15,
        penguin: 6,
        rabbit: 8,
        yeti: 8
      };

      var sequenceCount;
      var animalName;
      
      for (i = 0, iMax = animals.length; i < iMax; i++) {
        animalName = animals[i].dataset.animal;
        sequenceCount = sequences[animalName];
        images = [];
        positions = [];
        
        for (j = 1, jMax = sequenceCount; j <= jMax; j++) {
          images.push('url(img/sequence/' + animalName + j + '.png)');
          positions.push('50% 200em');
        }

        positions[0] = '50% 100%';

        animals[i].style.backgroundImage = images.join(',');
        animals[i].style.backgroundPosition = positions.join(',');
      }

      function preloadImg(src) {
        (new Image()).src = src;
      } 

      function getPositionString(activeIndex, count) {
        var positions = [];

        for (var j = 1, jMax = count; j <= jMax; j++) {
          positions.push('50% 200em');
        }

        positions[activeIndex - 1] = '50% 100%';
        return positions.join(',');
      }

      window.runAnimalSequence = function runAnimalSequence(animalEl) {
        var animal = animalEl.dataset.animal;

        if (sequences[animal]) {
          animalEl.reverse = !animalEl.reverse;
          animalFrame(animalEl, animal, animalEl.reverse ? 1 : sequences[animal], animalEl.reverse);
        }
      }

      function animalFrame(animalEl, animal, j, reverse) {
        var yoyo = (reverse && animalEl.dataset.yoyo)
          ? function () {
              runAnimalSequence(animalEl)
            }
          : null;
          
        var callback = (j <= 1) 
          ? yoyo
          : function () {
              animalFrame(animalEl, animal, j - 1, reverse)
            };

        if (reverse) {
          callback = (j >= sequences[animal]) 
            ? yoyo
            : function () {
                animalFrame(animalEl, animal, j + 1, reverse)
              };
        }
        
        TweenLite.set(
          animalEl,
          {
            backgroundPosition: getPositionString(j, sequences[animal]),
            onComplete: callback,
            delay: 0.03
          }
        )
      }

      var animalSequenceInterval = setInterval(function () {
        runAnimalSequence(animals[animalIndex]); 
      }, 3000)

      var shakeAudio = new Audio('shake.mp3');
      var tuneAudio = new Audio('tune.mp3');

      var muteEnabled = false;
      tuneAudio.loop = true;
      tuneAudio.volume = 0;
      playAudio(tuneAudio);

      document.getElementById('mute').addEventListener('click', toggleMute);

      function toggleMute() {
        muteEnabled = !muteEnabled;

        if (muteEnabled) {
          document.body.classList.add('-mute');
          pauseAudio(tuneAudio);
        } else {
          document.body.classList.remove('-mute');
          playAudio(tuneAudio);
        }
      }

      function pauseAudio(file) {   
        TweenLite.to(
          file, 
          0.6, 
          {
            volume: 0,
            onComplete: function () {
              file.pause();
            },
            overwrite: 'all',
            ease: Expo.easeOut
          }
        );
      }

      function playAudio(file) {   
        TweenLite.to(
          file, 
          3, 
          {
            volume: 0.1,
            onStart: function () {
              file.play();
            },
            overwrite: 'all',
            ease: Power1.easeOut
          }
        );
      }

      TweenLite.set(animals[0], {autoAlpha: 1, x: 0})


      var masterTl = new TimelineMax();
      i = n;

      while (i--) {
        flakes[i] = createFlake();
        flakesContainers[flakes[i].z > 0.75 ? 1 : 0].appendChild(flakes[i]);
        masterTl.add(createFlakeTween(i), fallSpeed * Math.random());
      }

      TweenLite.fromTo(
        masterTl,
        4,
        { timeScale: 3 },
        { timeScale: 1, ease: Expo.easeOut}
      );

      function createFlakeTween(i) {
        var rand1 = Math.random();
        var rand2 = Math.random();
        var plusOrMinus = rand2 < 0.5 ? -1 : 1;

        return TweenMax.fromTo(
          flakes[i],
          fallSpeed - flakes[i].z * 0.7 * fallSpeed,
          {
            y: 0,
            rotationX: 360 * rand1,
            rotationY: -30 * rand2
          },
          {
            y: h,
            rotationX: plusOrMinus * (360 * Math.random() + 180) + 360 * rand1,
            rotationY: 15 * Math.random() + -30 * rand2,
            ease: Power0.easeIn,
            repeat: -1
          }
        );
      }

      function createFlake() {
        var flake = document.createElement("div");
        flake.className = "flake";

        // polar coords
        var r = Math.sqrt(Math.random());
        var t = Math.random() * 2 * 3.14159;

        // cartesian in [0,1]x[0,1]
        var x = r * Math.cos(t) * 0.5 + 0.5;
        var z = r * Math.sin(t) * 0.5 + 0.5;

        TweenLite.set(flake, {
          scale: z * 0.5 + 0.5,
          rotationZ: Math.random() * 90,
          opacity: z * 0.8 + 0.2
        });

        flake.style.left = x * 100 + "%";
        flake.x = x;
        flake.z = z;

        return flake;
      }

            
      var ease = Expo.easeOut;
      var dur = 3;
      var shakeTl = new TimelineLite({paused: true});

      shakeTl.fromTo(
        masterTl,
        dur * 1.5,
        { timeScale: 50 },
        { timeScale: 1, ease: Expo.easeOut, immediateRender: false },
        0
      );
      shakeTl.fromTo(
        flakesContainers[0],
        dur * 1,
        { rotationZ: 0 },
        { rotationZ: 720, ease: Power4.easeOut, immediateRender: false , overwrite: 'all' },
        0
      );
      shakeTl.fromTo(
        flakesContainers[1],
        dur * 0.6,
        { rotationZ: 0 },
        { rotationZ: -1080, ease: Power4.easeOut, immediateRender: false, overwrite: 'all' },
        0
      );

      globe.onclick = shake;

      function shake(e) {        
        // var rect = e.currentTarget.getBoundingClientRect();
        // var offsetX = e.clientX - rect.left;
        // var offsetY = e.clientY - rect.top;
        // var shakeDirection = (rect.width / offsetX > 2) ? 1 : -1;
        var shakeDirection = -1;

        if (!muteEnabled) {
          shakeAudio.currentTime = 0;
          shakeAudio.play();
        }

        // TweenLite.set(toy, {transformOrigin: offsetX + 'px ' + offsetY + 'px '});

        TweenLite.fromTo(
          toy,
          1.5,
          { rotation: shakeDirection * -40 },
          { rotation: 0, ease: Elastic.easeOut.config(0.5, 0.1), immediateRender: false, overwrite: 'all' },
          0
        );

        TweenLite.fromTo(
          shadow,
          1.5,
          { scale: 1.5, opacity: 0.5},
          { scale: 1, opacity: 1, ease: Elastic.easeOut.config(0.5, 0.1), immediateRender: false, overwrite: 'all' },
          0
        );

        shakeTl.play(0);     

        slideOutAnimal(animalIndex);
        animalIndex = (animalIndex + 1) % animalCount;
        slideInAnimal(animalIndex);
      }


      function slideInAnimal(i) {
        TweenLite.fromTo(
          animals[i], 
          0.5, 
          {
            xPercent: 100,
            rotation: 0,
            autoAlpha: 1,
          },
          {
            xPercent: 0,
            autoAlpha: 1,
            immediateRender: false, 
            overwrite: 'all'
          }
        );
      }

      function slideOutAnimal(i) {
        TweenLite.fromTo(
          animals[i], 
          0.5, 
          {
            xPercent: 0,
            autoAlpha: 1
          },
          {
            xPercent: -100,
            autoAlpha: 0,
            immediateRender: false, 
            overwrite: 'all'
          }
        );
      }
    })();

  </script>
</body>
</html>
